---
# Source: safeline/templates/database/database-ss.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "release-name-safeline-database"
  labels:
    heritage: Helm
    release: release-name
    chart: safeline
    app: "safeline"
    component: database
spec:
  replicas: 1
  serviceName: "release-name-safeline-database"
  selector:
    matchLabels:
      release: release-name
      app: "safeline"
      component: database
  template:
    metadata:
      labels:
        heritage: Helm
        release: release-name
        chart: safeline
        app: "safeline"
        component: database
      annotations:
        checksum/secret: 15668c2f9521062e2e5bc236f05fb028d3ebf7e3b9f21d75498d79da02cfeabc
    spec:
      automountServiceAccountToken: false
      terminationGracePeriodSeconds: 120
      initContainers:
      - name: "delete-lost-found"
        image: swr.cn-east-3.myhuaweicloud.com/chaitin-safeline/safeline-postgres:15.2
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh"]
        args:
          - -c
          - |
            rm -rf /var/lib/postgresql/data/lost+found
        volumeMounts:
          - name: database-data
            mountPath: /var/lib/postgresql/data
            subPath: 
      containers:
      - name: database
        image: swr.cn-east-3.myhuaweicloud.com/chaitin-safeline/safeline-postgres:15.2
        imagePullPolicy: IfNotPresent
        envFrom:
          - secretRef:
              name: "release-name-safeline-database"
        env:
          # - name: PGDATA
          #   value: "/var/lib/postgresql/data/pgdata"
          - name: POSTGRES_USER
            value: safeline-ce
        volumeMounts:
          - name: database-data
            mountPath: /var/lib/postgresql/data
          - name: shm-volume
            mountPath: /dev/shm
          - name: localtime
            mountPath: /etc/localtime
            readOnly: true
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U safeline-ce -d safeline-ce
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U safeline-ce -d safeline-ce
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
      - name: localtime
        hostPath:
          path: /etc/localtime
      - name: shm-volume
        emptyDir:
          medium: Memory
          sizeLimit: 512Mi
  volumeClaimTemplates:
  - metadata:
      name: "database-data"
      labels:
        heritage: Helm
        release: release-name
        chart: safeline
        app: "safeline"
      annotations:
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: "1Gi"
